<html>
    <head>
        <script>
/*
callback: https://kurtkanaskie.github.io/oidc-client-code-wec/callback.html
    ?code=eyJhbGciOi...
    &state=A
    &scope=
*/
            var callback = document.URL;
            console.log("Code Callback URL: " + callback);
            if( callback.includes("#") ) { // OK
                var callbackResponse = callback.split("#")[1];
            } else { // error
                var callbackResponse = callback.split("?")[1];
            }
            var responseParameters = (callbackResponse).split("&");
            var parameterMap = [];
            for(var i = 0; i < responseParameters.length; i++) {
                var paramName = responseParameters[i].split("=")[0];
                var paramValue = responseParameters[i].split("=")[1];
                if( paramValue === undefined || paramValue === null ) { paramValue = "NA"; }
                console.log( "Param: " + paramName + ":" + paramValue );
                parameterMap[paramName] = paramValue;
            }
            console.log( "Callback code: " + parameterMap.code );
            console.log( "Callback state: " + parameterMap.state );
            console.log( "Callback scope: " + parameterMap.scope );

            if(parameterMap.code !== undefined && parameterMap.code !== null) {

                var fpdata = { 
                    client_id:'wkDnvYG73mmiSCdJqkxZELfkzLZ7YqJu',
                    client_secret:'s9QFxne0ghxLLsnS',
                    grant_type:'authorization_code',
                    code:parameterMap.code
                };

				console.log( "FPDATA: " + JSON.stringify(fpdata));

                // Ha Ha can't do this here, $http is not available, need to put in app controller.
                $http({
                    headers: {"Content-Type":"application/x-www-form-urlencoded"},
                    method : "POST",
                    url : "https://wec-nonprod-dev.apigee.net/azure-b2c/token",
                    data : fpdata
                }).then(function successCallback(response) {
                  console.log( "POST /token OK: " + response.status + JSON.stringify(response.data) );
                  $scope.status = response.status;
                  $scope.message = "OK";
                  $scope.tokenResponse = response.data;

					var oidc = {
						oauth: {
							code: parameterMap.code,
							state: parameterMap.state,
							scope: parameterMap.scope,
							access_token: response.data.access_token
						}
					};
					window.localStorage.setItem("oidc", JSON.stringify(oidc));
					console.log( "OIDC: " + JSON.stringify(oidc));
                }, function errorCallback(response) {
                  console.log( "POST /token ERROR: " + response.status + " - " + response.statusText + " - " + JSON.stringify(response.data) );
                  $scope.status = response.status;
                  $scope.message = response.statusText
                  $scope.tokenResponse = {};
					window.localStorage.setItem("oidc", "");
					alert("Problem getting access_token");
                });

            } else {
	    		console.log( "Callback error: " + parameterMap.error );
                window.localStorage.setItem("oidc", "");
                alert("Problem authenticating");
            }

            var url = window.location.href;
            var redirect = url.substring(0,url.lastIndexOf('/')) + "/index.html#/home";
            console.log( "Callback and Redirect: " + url + " redirect: " + redirect);
            window.location.href = redirect;

        </script>
    </head>
    <body>Redirecting...</body>
</html>
